<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>3D Part Selector - New Trad EVO</title>
    
    <!-- PDF Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>

    <style>
        body { margin: 0; font-family: 'Segoe UI', sans-serif; overflow: hidden; display: flex; height: 100vh; background: #f4f4f4; }
        
        #viewport { flex: 1; position: relative; background: #f0f0f0; }
        #sidebar { 
            width: 380px; background: white; border-left: 1px solid #ddd; 
            display: flex; flex-direction: column; padding: 20px; 
            box-shadow: -5px 0 15px rgba(0,0,0,0.05); 
        }
        
        /* Loading Screen */
        #loading-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: white; display: flex; flex-direction: column;
            align-items: center; justify-content: center; z-index: 1000;
        }
        #progress-bar { width: 250px; height: 8px; background: #eee; border-radius: 4px; margin-top: 15px; overflow: hidden; }
        #progress-fill { width: 0%; height: 100%; background: #007bff; transition: width 0.2s; }
        #error-display { color: red; margin-top: 20px; font-weight: bold; display: none; text-align: center; padding: 0 20px; }

        /* Interaction UI */
        #popup-ui { 
            position: absolute; bottom: 30px; left: 50%; transform: translateX(-50%);
            background: white; padding: 20px; border-radius: 12px; box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none; text-align: center; min-width: 280px; z-index: 100;
        }
        #length-input-box { margin: 10px 0; padding: 10px; background: #fff9e6; border-radius: 6px; border: 1px solid #ffeeba; display: none; }
        
        /* Sidebar Elements */
        h2 { margin-top: 0; padding-bottom: 10px; border-bottom: 2px solid #007bff; }
        #basket-list { list-style: none; padding: 0; margin: 0; overflow-y: auto; flex-grow: 1; }
        .basket-item { background: #fff; border: 1px solid #eee; border-radius: 8px; padding: 12px; margin-bottom: 10px; }
        .qty-row { display: flex; align-items: center; justify-content: space-between; margin-top: 10px; background: #f8f9fa; padding: 5px; border-radius: 4px; }
        
        .btn-add { background: #28a745; color: white; border: none; padding: 12px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .qty-btn { width: 30px; height: 30px; border: 1px solid #ccc; background: white; cursor: pointer; }
        .btn-order { background: #007bff; color: white; border: none; padding: 15px; border-radius: 8px; cursor: pointer; font-weight: bold; width: 100%; margin-top: 10px; }
        .btn-order:disabled { background: #ccc; cursor: not-allowed; }
        #empty-msg { color: #888; text-align: center; margin-top: 40px; }
    </style>
</head>
<body>

    <div id="loading-screen">
        <h2 id="loading-status">Loading: New trad EVO.glb</h2>
        <div id="progress-bar"><div id="progress-fill"></div></div>
        <div id="error-display"></div>
    </div>

    <div id="viewport">
        <div id="popup-ui">
            <strong id="selected-name-display" style="font-size: 1.2rem;">Part Name</strong>
            <div id="length-input-box">
                <label style="font-size: 0.9rem; font-weight: bold;">Order Length (mm):</label><br>
                <input type="number" id="length-val-field" value="1000" style="width: 100px; padding: 5px;">
            </div>
            <button class="btn-add" id="add-to-basket-btn">Add to Basket</button>
        </div>
    </div>

    <div id="sidebar">
        <h2>Basket</h2>
        <div id="empty-msg">No parts selected.</div>
        <ul id="basket-list"></ul>
        <div id="basket-footer" style="margin-top:auto; padding-top:10px;">
            <button class="btn-order" id="order-items-btn" disabled>Generate Order PDF</button>
        </div>
    </div>

    <script type="importmap">
        {
            "imports": {
                "three": "https://unpkg.com/three@0.160.0/build/three.module.js",
                "three/addons/": "https://unpkg.com/three@0.160.0/examples/jsm/"
            }
        }
    </script>

    <script type="module">
        import * as THREE from 'three';
        import { GLTFLoader } from 'three/addons/loaders/GLTFLoader.js';
        import { OrbitControls } from 'three/addons/controls/OrbitControls.js';

        // --- 1. INITIALIZE SCENE ---
        const scene = new THREE.Scene();
        scene.background = new THREE.Color(0xfcfcfc);
        
        const camera = new THREE.PerspectiveCamera(45, (window.innerWidth - 380) / window.innerHeight, 0.1, 2000);
        camera.position.set(10, 10, 10);

        const renderer = new THREE.WebGLRenderer({ antialias: true, preserveDrawingBuffer: true });
        renderer.setSize(window.innerWidth - 380, window.innerHeight);
        renderer.setPixelRatio(window.devicePixelRatio);
        document.getElementById('viewport').appendChild(renderer.domElement);

        const controls = new OrbitControls(camera, renderer.domElement);
        
        scene.add(new THREE.AmbientLight(0xffffff, 1.2));
        const dirLight = new THREE.DirectionalLight(0xffffff, 1);
        dirLight.position.set(10, 20, 10);
        scene.add(dirLight);

        let currentModel = null;
        let selectedObject = null;
        let originalMaterials = new Map();

        // --- 2. FILE LOADING ---
        const fileName = 'New trad EVO.glb';
        const loader = new GLTFLoader();

        loader.load(
            fileName,
            (gltf) => {
                currentModel = gltf.scene;
                scene.add(currentModel);

                // FOCUS CAMERA: Center the model and frame it perfectly
                const box = new THREE.Box3().setFromObject(currentModel);
                const size = box.getSize(new THREE.Vector3());
                const center = box.getCenter(new THREE.Vector3());
                
                currentModel.position.x += (currentModel.position.x - center.x);
                currentModel.position.y += (currentModel.pos